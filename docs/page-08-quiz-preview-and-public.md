# 8. クイズプレビュー・公開ページ

## 概要

このドキュメントは、クイズプレビュー機能と公開ページの仕様を統合したものです。クイズエディタから直接アクセスできるシンプルなプレビューと、受験者向けの公開ページの両方について記載しています。

## A. クイズプレビュー機能

### 概要
クイズエディタから直接アクセスできるシンプルなプレビューページ。作成中のクイズが実際の受験者にどのように表示されるかを確認し、問題の流れやUIを検証できる。編集内容がリアルタイムに反映される。

### プレビューページ構成

1. **プレビューヘッダー**
   - 「プレビューモード」バッジ
   - 「編集に戻る」ボタン（クイズエディタへ）
   - 「詳細プレビュー」リンク（page-20への誘導）
   - デバイス切替（デスクトップ/モバイル）

2. **クイズ開始画面**
   - クイズタイトル
   - クイズ説明文
   - 問題数・合格点・時間制限の表示
   - 「開始する」ボタン

3. **受験者情報入力**（設定に応じて表示）
   - 名前入力フィールド
   - メールアドレス入力フィールド
   - カスタムフィールド（設定されている場合）
   - 「クイズを開始」ボタン

4. **問題表示エリア**
   - 問題番号表示（例：1/10）
   - 進捗バー
   - タイマー表示（時間制限がある場合）
   - 問題文
   - メディア表示（画像・動画・音声）
   - 回答選択肢（問題タイプに応じた表示）
   - ヒント表示ボタン（設定されている場合）

5. **ナビゲーション**
   - 「前へ」「次へ」ボタン
   - 問題番号ジャンプ（プロプラン）
   - 「提出」ボタン

6. **結果表示**（自動採点モードの場合）
   - スコア表示
   - 合格/不合格判定
   - 問題ごとの正解/不正解
   - 解説表示（設定されている場合）

7. **プレビュー機能パネル**
   - 回答をリセット
   - 特定の問題にジャンプ
   - 言語切替（ja/en）

### プレビュー技術仕様

- **コンポーネント構成**
  - `QuizPreviewHeader.tsx`
  - `QuizStartScreen.tsx`
  - `ParticipantForm.tsx`
  - `QuestionDisplay.tsx`
  - `QuestionNavigation.tsx`
  - `ResultsSummary.tsx`
  - `PreviewControls.tsx`
  - `ResponsiveContainer.tsx`

- **状態管理**
  - `useQuizPreviewStore.ts` - Zustandストア
    - 現在の問題インデックス
    - 模擬回答データ
    - プレビュー設定
    - デバイスモード

  ```typescript
  interface QuizPreviewState {
    currentQuestionIndex: number;
    mockAnswers: Record<string, any>;
    deviceMode: 'desktop' | 'mobile';
    isStarted: boolean;
    isCompleted: boolean;
    startTime: Date | null;
    // アクション
    startQuiz: () => void;
    submitAnswer: (questionId: string, answer: any) => void;
    navigateToQuestion: (index: number) => void;
    resetPreview: () => void;
  }
  ```

- **データ連携**
  - クイズエディタの最新データを取得
  - 編集内容のリアルタイム反映
  - 保存されていない変更も含めて表示

- **レスポンシブ表示**
  - デスクトップ: 標準レイアウト
  - モバイル: タッチ最適化されたUI
  - タブレット: 中間レイアウト

- **プレビュー専用機能**
  - データは保存されない
  - いつでもリセット可能
  - 問題間の自由な移動
  - 模擬タイマー（実際には制限なし）

- **API連携**
  - クイズデータ取得: `/api/quizzes/:id/preview-data`
  - 編集中データの一時取得: エディタストアから直接

- **ルーティング**
  - `/[lng]/dashboard/quizzes/[id]/preview`

## B. クイズ公開ページ

### 概要
作成したクイズが公開され、受験者がアクセスするページ。カスタムサブドメインを使用して公開され、メインアプリケーションとは別のレイアウトで表示される。共有URLを知っている人、またはパスワードを持っている人が受験できる。

### 公開ページ構成

1. **ヘッダー**
   - クイズタイトル
   - 組織ロゴ（設定されている場合）
   - テーマカラー（カスタマイズされている場合）

2. **導入セクション**
   - クイズの説明文
   - 合格点の表示（設定されている場合）
   - 時間制限の表示（設定されている場合）
   - 問題数と総配点
   - 「開始」ボタン

3. **パスワード保護（該当する場合）**
   - パスワード入力フィールド
   - エラーメッセージ表示
   - 「送信」ボタン

4. **受験者情報フォーム**
   - 名前/メールアドレス入力フィールド（匿名受験の場合）
   - その他必須フィールド（設定に応じて）
   - プライバシーポリシー同意チェックボックス
   - 「開始」ボタン

5. **クイズ本体**
   - 問題カウンター（例：Question 3 of 10）
   - 進捗バー
   - 残り時間表示（時間制限がある場合）
   - 問題文表示
   - メディア表示（画像/音声/動画）（設定されている場合）
   - 回答インターフェース（問題タイプに応じた表示）
   - ナビゲーションボタン（前へ/次へ）
   - 「ヒントを表示」ボタン（設定されている場合）

6. **回答インターフェース（問題タイプ別）**
   - マルバツ問題: 「はい/いいえ」または「○/×」ボタン
   - 指定択一問題: ラジオボタンのリスト
   - 複数選択問題: チェックボックスのリスト
   - 自由記述問題: テキストエリア
   - 高度な問題タイプ（プロプラン）:
     - 並べ替え問題: ドラッグ&ドロップインターフェース
     - 穴埋め問題: インラインテキスト入力
     - 図形指示問題: クリッカブルイメージ

7. **問題ナビゲーションパネル**
   - 問題番号一覧
   - 回答済み/未回答/フラグ付き表示
   - 問題間ジャンプ機能

8. **提出確認モーダル**
   - 未回答問題の警告
   - 最終確認メッセージ
   - 「提出」と「戻る」ボタン

9. **フッター**
   - 著作権表示
   - プラットフォームへの帰属表示（フリープラン）
   - ブランド非表示オプション（プロプラン）

### 公開ページ技術仕様

- **コンポーネント構成**
  - `QuizHeader.tsx`
  - `QuizIntroduction.tsx`
  - `PasswordProtection.tsx`
  - `ParticipantForm.tsx`
  - `QuizProgress.tsx`
  - `QuestionDisplay.tsx`
  - `AnswerInterfaces/`
    - `TrueFalseInput.tsx`
    - `MultipleChoiceInput.tsx`
    - `CheckboxInput.tsx`
    - `TextInput.tsx`
    - `AdvancedInputs/`
  - `NavigationPanel.tsx`
  - `SubmitConfirmation.tsx`
  - `QuizFooter.tsx`

- **状態管理**
  - `useQuizTakingStore.ts` - Zustandストア
    - 認証状態（パスワードチェック）
    - 受験者情報
    - 現在の問題インデックス
    - 回答データ
    - 残り時間
    - フラグ付き問題
    - 回答進捗状態

- **テーマ設定**
  - カスタムサブドメイン表示
  - 組織のカラースキーム適用
  - ロゴ表示
  - フォント設定

- **データ保存**
  - 回答のローカルストレージ自動保存
  - サーバーへの進捗定期送信（回線切断対策）

- **API連携**
  - クイズデータ取得: `/api/public/quizzes/:subdomain`
  - パスワード検証: `/api/public/quizzes/:subdomain/verify`
  - 回答保存: `/api/public/quizzes/:subdomain/save`
  - 回答提出: `/api/public/quizzes/:subdomain/submit`

- **セキュリティ機能**
  - CSRF対策
  - レート制限
  - 不正アクセス検知

- **レスポンシブ設計**
  - モバイル: 単一カラム表示、タッチフレンドリーインターフェース
  - タブレット: 最適化された問題表示、サイドパネルは折りたたみ可能
  - デスクトップ: フル機能表示、サイドナビゲーションパネル常時表示

## Next.js移行考慮事項

### プレビュー機能
- Server Component でクイズデータを初期取得
- Client Component でインタラクティブなプレビュー機能を実装
- エディタとの状態共有は Context または URL パラメータで実現
- モバイル/デスクトップ切替は CSS とメディアクエリで対応

### 公開ページ
- `app/quiz/[subdomain]/page.tsx` として実装
- ISRまたはSSGでクイズデータを事前レンダリング
- 認証チェックはクライアントコンポーネントで実装
- 回答提出はServer Actionとして実装
- メディア最適化はNext.js Imageコンポーネントで実装

## 他ページとの関係

- **page-07（クイズエディタ）**: 「プレビュー」ボタンから遷移、編集画面に戻る
- **page-12（クイズ受験）**: 実際の受験ページと同じUIを使用
- **page-20（詳細プレビュー）**: より高度なプレビュー機能が必要な場合に誘導

## 特記事項

### プレビュー機能
- プレビューデータは一切保存されない
- 編集中の未保存データも含めてプレビュー可能
- シンプルで軽量な実装を優先
- 基本的な動作確認に特化

### 公開ページ
- カスタムサブドメインでの公開
- パスワード保護オプション
- 受験データの自動保存機能
- 回線切断対策の実装