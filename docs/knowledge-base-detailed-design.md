# ナレッジベース機能 詳細設計書

## 1. システム構成

### 1.1 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    ユーザーインターフェース                    │
├─────────────────────────────────────────────────────────┤
│                      ビジネスロジック層                       │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐     │
│  │ コンテンツ   │  │   AI生成    │  │  品質管理   │     │
│  │   管理      │  │   エンジン   │  │  システム   │     │
│  └────────────┘  └────────────┘  └────────────┘     │
├─────────────────────────────────────────────────────────┤
│                      データアクセス層                        │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐     │
│  │ PostgreSQL │  │   MinIO    │  │   Redis    │     │
│  │    DB      │  │  Storage   │  │   Cache    │     │
│  └────────────┘  └────────────┘  └────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 1.2 データモデル設計

#### ナレッジドメイン（知識分野）
```
知識分野マスタ
├── ID（一意識別子）
├── 名称（例：数学、英語）
├── 説明
├── 親分野ID（階層構造）
├── チームID
├── 作成日時
└── 更新日時
```

#### ナレッジエントリー（知識コンテンツ）
```
知識コンテンツ
├── ID（一意識別子）
├── タイトル
├── 本文
├── コンテンツ種別
├── 分野ID
├── メタデータ（JSON）
│   ├── 対象学年
│   ├── 難易度
│   ├── キーワード
│   └── 関連概念
├── タグ（配列）
├── ステータス（下書き/公開/アーカイブ）
├── チームID
├── 作成者ID
├── バージョン
├── 作成日時
└── 更新日時
```

#### ナレッジソース（コンテンツ元）
```
コンテンツソース
├── ID（一意識別子）
├── 名称（ファイル名等）
├── 種別（アップロード/Web/手動）
├── URL（Webの場合）
├── ファイルキー（アップロードの場合）
├── ファイルサイズ
├── MIMEタイプ
├── エントリーID
└── 作成日時
```

## 2. 機能詳細

### 2.1 コンテンツ登録機能

#### 2.1.1 ファイルアップロード処理
```
1. ファイル受信
   ├── ファイル形式チェック
   ├── ファイルサイズチェック（最大50MB）
   └── ウイルススキャン

2. コンテンツ抽出
   ├── PDF → テキスト変換（Apache PDFBox）
   ├── Word → テキスト変換（Apache POI）
   ├── 画像 → OCR処理（Google Cloud Vision）
   └── 動画 → 文字起こし（Whisper API）

3. 構造化処理
   ├── 見出し抽出
   ├── 段落分割
   ├── 重要語句抽出
   └── メタデータ生成

4. 保存処理
   ├── MinIOへファイル保存
   ├── PostgreSQLへメタデータ保存
   └── 検索インデックス更新
```

#### 2.1.2 Web取り込み処理
```
1. URL検証
   ├── アクセス可能性チェック
   └── robots.txt確認

2. コンテンツ取得
   ├── HTMLパース
   ├── 本文抽出
   └── 画像・リンク処理

3. 構造化・保存
   └── （ファイルアップロードと同様）
```

### 2.2 AI問題生成エンジン

#### 2.2.1 生成テンプレート
```
選択式問題テンプレート
├── プロンプトテンプレート
│   ├── システムプロンプト
│   └── ユーザープロンプト
├── 制約条件
│   ├── 選択肢数（4〜5）
│   ├── 文字数制限
│   └── 難易度指定
└── 後処理ルール
    ├── 選択肢シャッフル
    └── 正答位置調整
```

#### 2.2.2 生成フロー
```
1. コンテキスト準備
   ├── 関連ナレッジ取得
   ├── 重要概念抽出
   └── 参照情報整理

2. プロンプト構築
   ├── テンプレート選択
   ├── 変数置換
   └── 制約条件付与

3. AI生成実行
   ├── APIコール（OpenAI/Claude）
   ├── レスポンス受信
   └── 構造化データ変換

4. 品質検証
   ├── 形式チェック
   ├── 内容妥当性確認
   └── 重複チェック

5. 後処理
   ├── 形式整形
   ├── 難易度調整
   └── 解説生成
```

### 2.3 バッチ処理システム

#### 2.3.1 ジョブ管理
```
生成ジョブ
├── ジョブID
├── リクエスト内容
│   ├── 生成数
│   ├── 問題形式
│   └── パラメータ
├── ステータス
│   ├── 待機中
│   ├── 処理中
│   ├── 完了
│   └── エラー
├── 進捗情報
│   ├── 総数
│   ├── 完了数
│   └── 推定残り時間
└── 結果
    ├── 生成問題リスト
    └── エラーログ
```

#### 2.3.2 処理最適化
```
並列処理
├── 最大同時実行数: 5
├── タイムアウト: 5分/問題
└── リトライ: 最大3回

キャッシュ戦略
├── プロンプトキャッシュ（1時間）
├── 生成結果キャッシュ（24時間）
└── ナレッジキャッシュ（1週間）
```

## 3. 画面設計

### 3.1 ナレッジベース管理画面

#### 3.1.1 メイン画面構成
```
┌─────────────────────────────────────────────────┐
│ [←] ナレッジベース  [検索____] [+新規] [⚙設定]   │
├─────────────┬───────────────────────────────────┤
│ 分野一覧     │  コンテンツ一覧                    │
│             │ ┌─────────────────────────────┐ │
│ ▼ 数学      │ │ □ 二次関数の基礎        │ │
│   ▷ 代数    │ │    2024/01/15 PDF 15頁   │ │
│   ▼ 幾何    │ ├─────────────────────────────┤ │
│     • 図形  │ │ □ 三角形の性質          │ │
│     • 証明  │ │    2024/01/10 Word 8頁   │ │
│ ▷ 英語      │ └─────────────────────────────┘ │
│             │ [1] [2] [3] ... [10]  次へ →     │
└─────────────┴───────────────────────────────────┘
```

#### 3.1.2 コンテンツ詳細画面
```
┌─────────────────────────────────────────────────┐
│ [←戻る]  二次関数の基礎  [編集] [削除]          │
├─────────────────────────────────────────────────┤
│ 基本情報                                        │
│ ├ 分野: 数学 > 代数 > 二次関数                  │
│ ├ 対象: 高校1年生                              │
│ ├ 作成: 2024/01/15 山田太郎                    │
│ └ ソース: textbook_ch3.pdf                     │
├─────────────────────────────────────────────────┤
│ コンテンツプレビュー                            │
│ ┌─────────────────────────────────────────┐ │
│ │ 二次関数 y = ax² + bx + c について...     │ │
│ │                                          │ │
│ └─────────────────────────────────────────┘ │
├─────────────────────────────────────────────────┤
│ 関連情報                                        │
│ • タグ: #二次関数 #グラフ #頂点               │
│ • 生成済み問題: 45問                          │
│ • 最終利用: 2024/02/01                        │
└─────────────────────────────────────────────────┘
```

### 3.2 AI問題生成画面

#### 3.2.1 生成ウィザード（ステップ1: コンテンツ選択）
```
┌─────────────────────────────────────────────────┐
│ AI問題生成 - ステップ 1/4                       │
├─────────────────────────────────────────────────┤
│ 📚 出題範囲を選択してください                   │
│                                                │
│ □ 分野から選択                                 │
│   [数学 > 代数 > 二次関数 ▼]                  │
│                                                │
│ ☑ 特定のコンテンツを選択                       │
│   ├ ☑ 二次関数の基礎                         │
│   ├ ☑ 二次関数のグラフ                       │
│   └ □ 二次関数の応用                         │
│                                                │
│ □ キーワードで絞り込み                         │
│   [頂点、軸、判別式_____]                     │
│                                                │
│ 選択済み: 2件                                  │
├─────────────────────────────────────────────────┤
│ [キャンセル]              [次へ: 問題設定 →]    │
└─────────────────────────────────────────────────┘
```

#### 3.2.2 生成ウィザード（ステップ2: 問題設定）
```
┌─────────────────────────────────────────────────┐
│ AI問題生成 - ステップ 2/4                       │
├─────────────────────────────────────────────────┤
│ ⚙️ 生成する問題の設定                          │
│                                                │
│ 問題数: [10_____] 問                          │
│                                                │
│ 問題形式:                                      │
│ ☑ 選択式（4択）    [6] 問                    │
│ ☑ 正誤問題         [2] 問                    │
│ ☑ 穴埋め問題       [2] 問                    │
│ □ 記述式           [0] 問                    │
│                                                │
│ 難易度配分:                                    │
│ 初級 [###___] 30%                             │
│ 中級 [#####_] 50%                             │
│ 上級 [##____] 20%                             │
│                                                │
│ 詳細オプション ▼                              │
├─────────────────────────────────────────────────┤
│ [← 戻る]                    [次へ: 確認 →]     │
└─────────────────────────────────────────────────┘
```

#### 3.2.3 生成結果確認画面
```
┌─────────────────────────────────────────────────┐
│ AI問題生成 - 生成完了                           │
├─────────────────────────────────────────────────┤
│ ✅ 10問の問題が生成されました                   │
│                                                │
│ 生成された問題:                                │
│ ┌─────────────────────────────────────────┐ │
│ │ Q1. [選択式] 二次関数 y = x² - 4x + 3... │ │
│ │ [✓承認] [編集] [削除]                   │ │
│ ├─────────────────────────────────────────┤ │
│ │ Q2. [正誤] 放物線の頂点は...            │ │
│ │ [✓承認] [編集] [削除]                   │ │
│ └─────────────────────────────────────────┘ │
│                                                │
│ 一括操作: [全て承認] [全て編集モード]          │
├─────────────────────────────────────────────────┤
│ [やり直す]    [選択した問題をクイズに追加 →]    │
└─────────────────────────────────────────────────┘
```

### 3.3 レビュー・編集画面

#### 3.3.1 問題編集モード
```
┌─────────────────────────────────────────────────┐
│ 問題を編集                                [×]   │
├─────────────────────────────────────────────────┤
│ 問題文:                                        │
│ ┌─────────────────────────────────────────┐ │
│ │ 二次関数 y = x² - 4x + 3 の頂点の座標は？│ │
│ └─────────────────────────────────────────┘ │
│                                                │
│ 選択肢:                                        │
│ ○ (2, -1)  ← 正答                            │
│ ○ (2, 1)                                     │
│ ○ (-2, -1)                                   │
│ ○ (-2, 1)                                    │
│ [+ 選択肢を追加]                              │
│                                                │
│ 解説:                                          │
│ ┌─────────────────────────────────────────┐ │
│ │ 平方完成により y = (x-2)² - 1 となり... │ │
│ └─────────────────────────────────────┘ │
│                                                │
│ 難易度: [初級 ▼]  配点: [2] 点               │
├─────────────────────────────────────────────────┤
│ [キャンセル]                      [保存]        │
└─────────────────────────────────────────────────┘
```

## 4. API仕様

### 4.1 ナレッジベースAPI

#### コンテンツアップロード
```
POST /api/knowledge/upload
Content-Type: multipart/form-data

Request:
{
  "file": <binary>,
  "domainId": "domain123",
  "metadata": {
    "gradeLevel": "high1",
    "tags": ["二次関数", "数学"]
  }
}

Response:
{
  "entryId": "entry456",
  "status": "processing",
  "estimatedTime": 30
}
```

#### コンテンツ検索
```
GET /api/knowledge/search?q=二次関数&domain=math

Response:
{
  "results": [
    {
      "id": "entry123",
      "title": "二次関数の基礎",
      "excerpt": "二次関数 y = ax² + bx + c について...",
      "relevance": 0.95
    }
  ],
  "total": 15,
  "page": 1
}
```

### 4.2 AI生成API

#### 問題生成リクエスト
```
POST /api/ai/generate

Request:
{
  "knowledgeEntryIds": ["entry123", "entry456"],
  "config": {
    "count": 10,
    "types": {
      "multipleChoice": 6,
      "trueFalse": 2,
      "fillInBlank": 2
    },
    "difficulty": {
      "beginner": 0.3,
      "intermediate": 0.5,
      "advanced": 0.2
    }
  }
}

Response:
{
  "jobId": "job789",
  "status": "queued",
  "estimatedTime": 60
}
```

#### 生成状況確認
```
GET /api/ai/jobs/job789

Response:
{
  "jobId": "job789",
  "status": "processing",
  "progress": {
    "total": 10,
    "completed": 6,
    "failed": 0
  },
  "estimatedTimeRemaining": 24
}
```

## 5. エラー処理

### 5.1 エラーコード体系
```
E1xxx: 入力エラー
├ E1001: ファイル形式エラー
├ E1002: ファイルサイズ超過
└ E1003: 必須項目未入力

E2xxx: 処理エラー
├ E2001: コンテンツ抽出失敗
├ E2002: AI生成失敗
└ E2003: タイムアウト

E3xxx: システムエラー
├ E3001: データベースエラー
├ E3002: ストレージエラー
└ E3003: 外部APIエラー
```

### 5.2 エラーメッセージ
```
ユーザー向けメッセージ例:
- "申し訳ございません。ファイルの処理中にエラーが発生しました。"
- "AI生成が混雑しています。しばらく待ってから再度お試しください。"
- "このファイル形式はサポートされていません。PDF、Word、テキストファイルをご利用ください。"
```

## 6. パフォーマンス要件

### 6.1 レスポンスタイム
- コンテンツアップロード: 3秒以内（UIレスポンス）
- 検索: 1秒以内
- AI生成（10問）: 30秒〜1分
- 画面遷移: 0.5秒以内

### 6.2 同時実行数
- 同時アップロード: 最大10ファイル/ユーザー
- AI生成同時実行: 最大5ジョブ/チーム
- 検索同時実行: 制限なし

### 6.3 データ容量
- ナレッジベース: 
  - 無料: 100MB/チーム
  - Pro: 10GB/チーム
  - Enterprise: 無制限
- 生成履歴保存: 6ヶ月

## 7. セキュリティ設計

### 7.1 アクセス制御
```
権限マトリックス:
              │ 閲覧 │ 作成 │ 編集 │ 削除 │ AI生成 │
─────────────┼──────┼──────┼──────┼──────┼────────┤
オーナー      │  ○   │  ○   │  ○   │  ○   │   ○    │
管理者        │  ○   │  ○   │  ○   │  ○   │   ○    │
メンバー      │  ○   │  ○   │  ○   │  ×   │   ○    │
閲覧者        │  ○   │  ×   │  ×   │  ×   │   ×    │
```

### 7.2 データ保護
- 保存時暗号化（AES-256）
- 通信時暗号化（TLS 1.3）
- 定期バックアップ（日次）
- 監査ログ（1年保存）