# 14. プラン管理/アップグレードページ

## 概要
ユーザーが現在のプランを確認し、アップグレードや支払い情報の管理ができるページ。使用状況の表示、プラン比較、支払い履歴などの機能を提供する。

## ページ構成
1. **現在のプラン概要**
   - プラン名（フリー/プロ/エンタープライズ）
   - 月額/年額表示
   - 次回請求日
   - 「プランを変更」ボタン

2. **使用状況ダッシュボード**
   - リソース使用状況のグラフィカル表示
     - メンバー数（例：15/20）
     - クイズ数（例：8/無制限）
     - ストレージ使用量（例：4.2GB/10GB）
     - 月間回答数（例：1,200/3,000）
   - 各制限に対するプログレスバー
   - 使用率の高いリソースのアラート/警告

3. **プラン比較テーブル**
   - 現在のプランがハイライト表示された3つのプランの比較
   - 「アップグレード」ボタン
   - 「年間プランで17%節約」などのプロモーション

4. **請求情報フォーム**
   - 請求先情報
     - 名前/会社名
     - 住所
     - 税ID/VAT番号（該当する場合）
   - 「更新」ボタン

5. **支払い方法管理**
   - 現在の支払い方法表示
   - クレジットカード追加/更新フォーム
   - 「デフォルトに設定」オプション

6. **請求履歴**
   - 過去の請求書リスト
   - 日付、金額、ステータス表示
   - 「PDFをダウンロード」ボタン

7. **プロモーションコード**
   - プロモーションコード入力フィールド
   - 「適用」ボタン
   - 現在適用中の割引表示

8. **プランのダウングレード/キャンセル**
   - ダウングレードオプション表示
   - キャンセル手続きへのリンク
   - 注意事項と影響の説明

## 技術仕様
- **コンポーネント構成**
  - `CurrentPlanSummary.tsx`
  - `UsageMeters.tsx`
  - `PlanComparisonTable.tsx`
  - `BillingInfoForm.tsx`
  - `PaymentMethodManager.tsx`
  - `InvoiceHistory.tsx`
  - `PromoCodeForm.tsx`
  - `PlanDowngradeOptions.tsx`

- **状態管理**
  - `useBillingStore.ts` - Zustandストア
    - フォーム状態
    - 選択されたプラン
    - プロモーションコード状態
  - TanStack Query
    - 請求情報取得
    - 使用状況データ取得
    - 請求履歴取得

- **Stripe連携**
  - カード情報入力（Stripe Elements）
  - 支払い処理
  - Webhook処理
  - 請求書生成

- **使用状況データ可視化**
  - プログレスバー
  - 円グラフ
  - 使用履歴グラフ（時系列）

- **プラン変更ロジック**
  - 即時変更オプション
  - 請求期間終了時の変更オプション
  - 日割り計算処理

- **API連携**
  - プラン情報取得: `/api/billing/plan`
  - 使用状況取得: `/api/billing/usage`
  - プラン変更: `/api/billing/change-plan`
  - 支払い方法更新: `/api/billing/payment-method`
  - 請求履歴取得: `/api/billing/invoices`

- **レスポンシブ設計**
  - モバイル: 単一カラム、セクション順次表示
  - タブレット: 2カラムグリッド
  - デスクトップ: 複数カラムレイアウト、サイドナビゲーション

## Next.js移行考慮事項
- 請求情報・使用状況の取得はServer Componentで実装
- Stripe Elements統合はクライアントコンポーネント化
- プラン変更処理はServer Actionとして実装
- 請求書のPDF生成と配信はAPI Routesとして実装
- StripeのwebhookエンドポイントはAPI Routesとして維持